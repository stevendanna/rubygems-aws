upstream <%= @resource.application.name %> {
  <% @hosts.each do |node| %>
  server <%= node.attribute?('cloud') ? node['cloud']['local_ipv4'] : node['ipaddress'] %>:<%= @resource.application_port %> fail_timeout=0;
  <% end %>
}

server {
  # port to listen on. Can also be set to an IP:PORT
  listen 80 default;

  # sets the domain[s] that this vhost server requests for
  server_name <%= @resource.server_name.is_a?(Array) ? @resource.server_name.join(' ') : @resource.server_name %>;

  <% if @resource.ssl %>
    # redirect all requests to SSL
    rewrite ^(.*) https://$host$1 permanent;
  <% else %>
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_redirect off;
    location / {
      proxy_pass http://<%= @resource.application.name %>;
    }
  <% end %>
}

<% if @resource.ssl %>
# HTTPS
server {
  # port to listen on. Can also be set to an IP:PORT
  listen 443 default ssl;

  server_name <%= @resource.server_name.is_a?(Array) ? @resource.server_name.join(' ') : @resource.server_name %>;

  # SSL settings
  ssl                         on;
  ssl_certificate             <%= @resource.ssl_certificate %>;
  ssl_certificate_key         <%= @resource.ssl_certificate_key %>;
  ssl_protocols               SSLv3 TLSv1;
  ssl_ciphers                 ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
  ssl_prefer_server_ciphers   on;
  keepalive_timeout           65;

  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header Content-Length $content_length;
  proxy_set_header Host $host;
  proxy_redirect off;

  location / {
    proxy_pass http://<%= @resource.application.name %>;
  }
}
<% end %>
